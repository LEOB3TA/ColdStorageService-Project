<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<!--
<script type="text/javascript" src="../css/issStyle.js"></script>
-->
<link rel="stylesheet" type="text/css" href="resources/css/sprint0.css">

<head>

    <title>Sprint1</title></head>

<body>
<!--
<div id="top">
    <h1><b>PROGETTO DI INGEGNERIA DEI SISTEMI SOFTWARE</b> - SPRINT 0 <font size="5"></font></h1>
    <h3>Gruppo di lavoro: Focardi, Galeone, Porrazzo <font size="3"></font></h3>
</div>
-->
<div class="body">
    <h2>Introduction</h2>
    <div class="remark"> Progetto finale di ISS, finalizzato allo sviluppo software di un magazzino refrigerato, nel
        quale
        vi &egrave; un robot che ha il compito di trasportare del cibo da un punto di partenza - chiamato INDOOR - alla cella
        frigorifera.
    </div>

    <h2>Requirements</h2>
    <div class="remark">
        <a href="https://htmlpreview.github.io/?https://github.com/anatali/issLab23/blob/main/iss23Material/html/TemaFinale23.html">Tema Finale </a>
    </div>

    <h3>Work plan</h3>
    <div class="remark">
        <ul>
            <li>A partire dallo sprint0 analizzare il core business dell'applicazione</li>
            <li>Trovare ad analizzare eventuali criticit&agrave; dei requisiti</li>
            <li>Implementare un <b>MockTruck</b> in modo da simulare un interazione del driver con la <b>ServiceAccessGui</b>, che interagisca con il <b>ColdStorageService</b></li>
            <li>Implementare il <b>ColdStorageService</b></li>
            <li>Implementare il <b>TrasportTrolley</b> e interfacciarlo con il <b>BasicRobot</b></li>
            <li>Testing del sistema</li>
            <li>Aggregare le varie componenti in modo da creare un primo prototipo del sistema</li>
        </ul>
    </div>

    <h2>Problem analysis</h2>
    <div class="remark">
        <h3>MockTruck</h3>
        <h5>Obiettivo</h5>
        Sviluppare un attore che simuli un driver che:
        <br>
        <ol>
            <li>Richieda un <b>Ticket</b></li>
            <li>Si rechi alla <b>INDOOR</b></li>
            <li>Presenti il ticket al <b>ColdStorageService</b> e attenda la risposta</li>
        </ol>
        <h5>Problemi</h5>
        Analizzando il testo dei requisiti possiamo dedurre i seguenti problemi:
        <br>
        <ol>
            <li><b>La richiesta del ticket e la presentazione del ticket avvengono in istanti di tempo diversi</b></li>
            Dall'esame dei requisiti forniti dal committente emerge che la richiesta di immagazzinamento del carico e la successiva presentazione del ticket all'<b>INDOOR</b> avvengono in momenti distinti.
            <li><b>Scadenza del ticket</b></li>
            Nel caso di accettazione della richiesta, viene fornito al conducente un ticket con un tempo limite entro il quale deve raggiungere l'<b>INDOOR</b>. Sorge quindi il dubbio se il conducente debba essere a conoscenza di tale scadenza.
            <li><b>Problema del load-time lungo</b></li>
            Quando il driver presenta il ticket &egrave; possibile che il <b>ColdStorageService</b> non riesca a fornire la risposta <b>chargeTaken</b> in tempi brevi, in quanto il <b>TrasportTrolley</b> potrebbe essere occupato, quindi il driver non saprebbe se la sua richiesta &egrave; in attesa di una risposta oppure se il ticket non &egrave; stato accettato.
            <li><b>Errore interno del ColdStorageService</b></li>
            Nel caso in cui il <b>ColdStorageService</b> incontri problemi interni che causano il malfunzionamento del servizio, &egrave importante stabilire come il conducente dovrebbe reagire.
            <li><b>Quando il driver deve liberare la indoor</b></li>
            Il driver deve liberare la <b>INDOOR</b> appena "as soon as possible" cio&egrave; appena preso il carico, oppure deve aspettare che il carico sia stato scaricato all'interno della <b>ColdRoom</b>
        </ol>
        <h5>Possibili soluzioni</h5>
        <ol>
            <li><b>La richiesta del ticket e la presentazione del ticket avvengono in istanti di tempo diversi</b></li>
            Il tempo in cui il driver si reca alla <b>INDOOR</b> non &egrave; trascurabile, di conseguenza &egrave; necessario introdurre una variabile <b>DT</b> (driver time) che rappresenta il tempo di viaggio.
            <li><b>Scadenza del ticket</b></li>
            Una possibile soluzione &egrave fornire al conducente la scadenza del ticket e, supponendo che egli abbia una stima del tempo di viaggio verso l'<b>INDOOR</b>, consentirgli di valutare se intraprendere il viaggio. In alternativa, il conducente potrebbe ricevere solo il <b>TICKETID</b> e recarsi comunque all'<b>INDOOR</b>, dove la validit&agrave del ticket verr&agrave verificata.
            Durante questa fase di sviluppo, &egrave stata adottata la seconda opzione, ma ulteriori dettagli dal committente sono necessari.
            <li><b>Problema del load-time lungo</b></li>
            Per sopperire a questo problema &egrave; necessario creare un interazione a due fasi: una in cui il driver presenta il proprio ticket (<b>sendTicket</b>) e riceve una risposta da parte del ColdStorageService (<b>ticketAccepted/ticketRejected</b>); e una in cui il driver invia la richiesta di deposito (<b>deposit</b>) e riceve poi <b>chargeTaken</b>
            <li><b>Errore interno del ColdStorageService</b></li>
            &Egrave; possibile introdurre un timeout per ogni richiesta, in modo che il driver abbandoni alla scadenza del timer. Il timer &egrave; stato fissato a <b>60</b> secondi.
            <li><b>Quando il driver deve liberare la indoor</b></li>
            In questa fase di sviluppo &egrave; stato adottato l'approccio "as soon as possible"
        </ol>
    </div>

    <h2>Architettura Logica</h2>
     <div class="remark">
             <br>
         Modello: <a style="font-size: larger" href="https://github.com/LEOB3TA/issProject2023/blob/main/Sprint1/src/sprint1.qak" target="_blank">sprint1.qak</a> <!-- TODO fare il modello completo -->
         <br>
             <img src="./resources/images/coldstorageservicearch.png" alt="architettura logica"> <!-- TODO inserire l'immagine corretta-->

     </div>


       <!--  <h2>Piano di lavoro</h2>

         </div> -->

             <h2>Project</h2>
              <div class="remark">
                      <h3>MockTruck</h3>
                      Il MockTruck &egrave stato modellato come un <b>Attore Qak</b>. Esso &egrave composto da vari stati, i quali si ripetono ciclicamente per simulare l'interazione di un conducente con la <b>ServiceAccessGUI</b>.<br>
                      I messaggi di risposta del ticket sono stati modificati in <b>ticketValid</b>/<b>ticketNotValid</b>/<b>ticketExpired</b>.<br>
                      Questo comportamento non implica la presenza di conducenti multipli, ma piuttosto di uno che cerca ciclicamente di effettuare un deposito. Di seguito &egrave riportato il diagramma degli stati e il diagramma delle interazioni con il ColdStorageService.
                      <br>
                      <img src="resources/images/MockTruckState.drawio.png" alt="MockTruckState">
                      <br>
                      <br>
                      <img src="resources/images/interactionChartMockTruck.drawio.png" alt="MockTruckState">
                      <br>
                      Gli stati che rappresentano un rifiuto o un errore del sistema (Rejected, HandleError, handleTicketExpired) mostrano messaggi di errore e ritornano all'inizio ciclo.<br> Lo stato handleTicketNotValid stampa un messaggio di errore e riprova ad inserire di nuovo il ticket.<br></bRE> La transizione tra gli stati <b>Accepted</b> e <b>SendTicket</b> rappresenta il percorso che il conducente deve intraprendere per arrivare all'area <b>INDOOR</b>.
                      Lo stato <b>SendDeposit</b> implementa l'approccio "as soon as possible" descritto nell'analisi del problema: appena il messaggio <b>chargeTaken</b> viene ricevuto, il conducente lascia l'area indoor. Prima di riprendere il ciclo, nello stato <b>IDLE</b> &egrave presente una pausa.
                      <pre>
Thread.sleep(Random.nextLong(1, 2001))
   </pre>
                      Sono presenti tre variabili che vengono modificate ad ogni ciclo.
                      <pre>
var FW = 0
var DT = 1000L
var TICKETID = 0
   </pre>
                      In particolare, le variabili <b>FW</b> e <b>DT</b> vengono inizializzate con valori casuali attraverso una funzione all'interno dello stato <b>IDLE</b>:
                      <pre>
fun initDriver(){
    FW = Random.nextInt(1, 101)
    DT = Random.nextLong(1, 2001)
}
   </pre>
                      Invece la variabile <b>TICKETID</b> viene assegnata nello stato <b>Accepted</b>, prendendo il valore dalla risposta <b>storeAccepted</b>.
                      <pre>
onMsg (storeAccepted : storeAccepted(TICKETID)){
    [#
        TICKETID = payloadArg(0).toInt()
    #]
}
   </pre>
                  </div>

             </div>

         <h2>Testing</h2>
         <div class="remark">
             <!-- TODO vedere se inserire le classi di utilit&agrave coapobs-->
             <h3>MockTruck</h3>
                Per testare il <b>MockTruck</b> &egrave; stata creata la classe che rappresenta lo stato del truck <a href="">TruckState.kt</a> <!-- TODO inserire il link -->; all'interno del quale &egrave presente anche un enumerativo che rappresenta i possibili stati che pu&ograve assumere il mocktruck:
             <pre>
enum class CurrStateTruck { IDLE, SENDSTORE, REJECTED, ACCEPTED, SENDTICKET, HANDLETICKETEXPIRED, SENDDEPOSIT, HANDLEERROR}
                 </pre>
             Nell'ambito dell'attore Qak, &egrave stata introdotta una nuova variabile denominata <b>truckstate</b>:

             <pre>
val truckstate = TruckState()
</pre>
             Questa variabile viene aggiornata ogni volta che lo stato del truck cambia, mediante le seguenti operazioni:

             <pre>
[#truckstate.setState(CurrStateTruck.CURRENTSTATE)#]
updateResource[#truckstate.toJsonString()#]
</pre>
             In questo modo un <b>observer</b> pu&ograve osservare lo stato del mock truck in modo da rendere pi&ugrave; semplici i test.
             <br>
             L'attore &egrave stato ulteriormente modificato con l'aggiunta di nuovi <b>Dispatch</b> che consentono alla classe di test di modificare lo stato. Di seguito sono elencati gli stati con le relative transizioni:
             <pre>
Dispatch testStore : testStore(_)
Dispatch testTicket : testTicket(_)
Dispatch testDeposit : testDeposit(_)
Dispatch reset : reset(_)

whenMsg testStore -> sendStore
whenMsg testTicket -> sendTicket
whenMsg testDeposit -> sendDeposit
whenMsg reset -> idle
             </pre>
             Le procedure di test sono implementate all'interno del file <a href="">TestMockTruckActor.kt</a> <!-- TODO inserire il link -->. Il metodo <b>@Before</b> si occupa dell'inizializzazione della connessione o, se gi&agrave inizializzata, invia il messaggio <b>reset</b> al mocktruck.

             Ciascun test inizia inviando un <b>dispatch</b> che imposta lo stato desiderato del mocktruck, seguito dall'esecuzione delle operazioni di test e dalla verifica dei risultati. Ecco un esempio:
             <pre>
@Before
fun before() {
    if(!setupOk){
        //setup
    }else{
        println("TestMockTruckActor       | clearHistory and reset")
        Thread.sleep(2000)
        conn.forward("msg(reset, dispatch, testunit, mockTruck, reset(_), 1)")
        obs.clearHistory()
    }
}


@Test
@Throws(InterruptedException::class)
fun testStoreFoodAccepted(){
    conn.forward("msg(testStore, dispatch, testunit, mockTruck, testStore(_), 1)")
    println("TestMockTruckActor  |   testStoreFoodAccepted...")
    try {
        conn.reply("msg(storeAccepted, reply, testunit, mockTruck, storeAccepted(1), 1)")
    }catch (e:Exception){
        e.printStackTrace()
    }
    Thread.sleep(2000)
    val newState = obs.currentTypedState!!.toString()
    println(newState)
    Assert.assertTrue(newState.contains("ACCEPTED"))
}
</pre>
             Questi metodi di test sono finalizzati a verificare diverse situazioni, ad esempio lo stato "ACCEPTED" dopo un tentativo di memorizzazione (<b>testStoreFoodAccepted</b>), lo stato "REJECTED" dopo un tentativo di memorizzazione non riuscito (<b>testStoreFoodRejected</b>), lo stato "TICKETEXPIRED" dopo l'invio di un biglietto scaduto (<b>testSendTicketExpired</b>), e cos&igrave; via. Ogni test invia i messaggi appropriati, aspetta un breve periodo di tempo per la risposta e quindi verifica lo stato attuale del mock truck.

             In questo modo, si garantisce che il mock truck si comporti correttamente in diverse circostanze e che gli stati cambino secondo le aspettative.
         </div>

<!--
         <h2>Deployment</h2>
         <div class="remark">

         </div>


         <h2>Maintenance</h2>
         -->
<!-- USEFUL
<table style="width:100%" border="1">
<tr>
<td style="width:40%">
</td>
<td></td>
</tr>
</table>
-->

<br/><br/>
</div>

<div class="stud">
    By Students: <br>
    <div class="studentCardRow">
    <div class="studentCard">
        <div class="studentName">Leonardo Focardi</div>
        <div class="studentEmail"><a href= "mailto:leonardo.focardi@studio.unibo.it">leonardo.focardi@studio.unibo.it</a>
            </div>
        <div class="studentImg"><img class="studentAvatar" src="resources/boys/leo.jpg"></div>
    </div>
        <div class="studentCard">
            <div class="studentName">Christian Galeone</div>
            <div class="studentEmail"><a href= "mailto:christian.galeone@studio.unibo.it">christian.galeone@studio.unibo.it</a></div>
            <div class="studentImg"><img class="studentAvatar" src="resources/boys/christian.jpg"></div>
        </div>
        <div class="studentCard">
            <div class="studentName">Gianmiriano Porrazzo</div>
            <div class="studentEmail"><a href= "mailto:gianmiriano.porrazzo@studio.unibo.it">gianmiriano.porrazzo@studio.unibo.it</a></div>
            <div class="studentImg"><img class="studentAvatar" src="resources/boys/gian.jpg"></div>
        </div>
    </div>

    <div class="repo">
        GIT repo: <a href="https://github.com/LEOB3TA/issProject2023">https://github.com/LEOB3TA/issProject2023</a>
    </div>

</div>
</body>
</html>
